<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AUBus - Live Map</title>
    <style>
        #map {
            height: 100%;
            width: 100%;
            border-radius: 10px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        .error-message {
            padding: 20px;
            text-align: center;
            background: #ffebee;
            color: #c62828;
            border-radius: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="error" style="display: none;"></div>

    <script>
        let map;
        let driverMarker;
        let studentMarker;
        let destinationMarker;
        let directionsService;
        let directionsRenderer;

        // Initialize the map
        function initMap() {
            console.log('Initializing Google Maps...');
            
            // Default center (Beirut coordinates)
            const defaultCenter = { lat: 33.8938, lng: 35.5018 };
            
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 14,
                    center: defaultCenter,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true
                });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            mapInitialized = true;
            console.log('Map initialized successfully - ready for dynamic locations');
                
            } catch (error) {
                console.error('Error initializing map:', error);
                showError('Error initializing map: ' + error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = `<div class="error-message"><strong>Map Error:</strong> ${message}</div>`;
            errorDiv.style.display = 'block';
            console.error('Map Error:', message);
        }

        // Update driver location on the map
        function updateDriverLocation(lat, lng) {
            if (!map) {
                console.warn('Map not initialized yet');
                return;
            }

            const position = { lat: lat, lng: lng };
            
            if (!driverMarker) {
                driverMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: 'Driver',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="15" fill="#4285F4" stroke="white" stroke-width="2"/>
                                <text x="20" y="26" text-anchor="middle" fill="white" font-size="14">ðŸš—</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
            } else {
                driverMarker.setPosition(position);
            }

            map.setCenter(position);
            console.log('Driver location updated:', lat, lng);
        }

        // Set student pickup location
        function setStudentLocation(lat, lng) {
            if (!map) {
                console.warn('Map not initialized yet');
                return;
            }

            const position = { lat: lat, lng: lng };
            
            if (!studentMarker) {
                studentMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: 'Student Pickup',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="30" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="15" cy="15" r="12" fill="#34A853" stroke="white" stroke-width="2"/>
                                <text x="15" y="20" text-anchor="middle" fill="white" font-size="12">ðŸ‘¤</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 30)
                    }
                });
            } else {
                studentMarker.setPosition(position);
            }
            
            console.log('Student location set:', lat, lng);
        }

        // Set destination location
        function setDestinationLocation(lat, lng) {
            if (!map) {
                console.warn('Map not initialized yet');
                return;
            }

            const position = { lat: lat, lng: lng };
            
            if (!destinationMarker) {
                destinationMarker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: 'Destination (AUB)',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="35" height="35" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="17.5" cy="17.5" r="14" fill="#EA4335" stroke="white" stroke-width="2"/>
                                <text x="17.5" y="22" text-anchor="middle" fill="white" font-size="12">ðŸŽ¯</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(35, 35)
                    }
                });
            } else {
                destinationMarker.setPosition(position);
            }
            
            console.log('Destination set:', lat, lng);
        }

        // Draw route between two points
        function drawRoute(startLat, startLng, endLat, endLng) {
            if (!map || !directionsService) {
                console.warn('Map or directions service not initialized');
                return;
            }

            const start = new google.maps.LatLng(startLat, startLng);
            const end = new google.maps.LatLng(endLat, endLng);

            const request = {
                origin: start,
                destination: end,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    console.log('Route drawn successfully');
                } else {
                    console.error('Error drawing route:', status);
                }
            });
        }

        // Handle Google Maps script load errors
        window.gmapsError = function(error) {
            console.error('Google Maps script failed to load:', error);
            showError('Failed to load Google Maps. Please check your API key.');
        };

        // Initialize when Google Maps loads
        window.initMap = initMap;

    </script>

    <!-- Load Google Maps with API key placeholder -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBp_oQI9HENN1ikS1sz8qDinI-Q3ucvoX4&callback=initMap&libraries=geometry"
    onerror="gmapsError('Script load failed')">
</script>
</body>
</html>
    <script>
// Add this function to get real GPS coordinates
function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation is not supported by this browser.'));
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                console.log('Real GPS coordinates:', lat, lng);
                resolve({ lat, lng });
            },
            (error) => {
                console.error('Geolocation error:', error);
                reject(error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    });
}

// Function to send coordinates to Python
function sendCoordinatesToPython(lat, lng) {
    // This will be called from Python to get the coordinates
    if (window.pyWebView) {
        window.pyWebView.postMessage(JSON.stringify({
            type: 'gps_coordinates',
            latitude: lat,
            longitude: lng
        }));
    }
    return { lat, lng };
}
</script>

<script>
// Automatically try to get location when bridge is ready
function attemptGeolocation() {
    getCurrentLocation().then(coords => {
        console.log("GPS coordinates: " + coords.lat + "," + coords.lng);
        sendCoordinatesToPython(coords.lat, coords.lng);
        window.currentLocation = coords;
    }).catch(error => {
        console.log("Geolocation failed: " + error.message);
        // Fallback to AUB coordinates
        sendCoordinatesToPython(33.8997, 35.4812);
    });
}

// Call this when the bridge is ready
if (window.pyWebView) {
    attemptGeolocation();
}
</script>